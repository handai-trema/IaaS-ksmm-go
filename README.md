How to use
----------

## 用意する端末(PC)
- Tremaのコントローラを動作させるための端末(Controller)
    - 実機スイッチのマネジメントポートと同じネットワークに所属するように、IPアドレスを設定しておく。
- サーバ用端末(Server)
    - Dockerコンテナを動かすための端末。Dockerをインストールしておく。
    - IPアドレス：192.168.10.10/24
- 管理者用端末(Admin)
    - ユーザからのリクエストにより、サーバ用端末にDockerコンテナを作成する端末。
    - IPアドレス：192.168.10.13/24
- ユーザ端末(User)
    - 管理者用端末と通信を行い、Dockerコンテナの作成を依頼する。コンテナが作成後は、コンテナとの通信が可能となる。
    - IPアドレス：192.168.10.51/24

## デモの再現方法
1. 今回作成したでは各端末は新しく接続を開始する端末に対しては、必ずARP解決が行われることを前提としてコントローラを実装している。そのため、デモの動作前に使用する端末に関するARPテーブルのキャッシュを各端末において削除する。
  ```
  sudo arp -d <ARPテーブルにキャッシュが残る端末のIPアドレス>
  ```
1. 実機スイッチのVSI間をケーブルで接続し、ネットワークを構築する。
1. Tremaのコントローラを、以下のコマンドで起動させる。  
    ```
    bundle exec trema run lib/routing_switch.rb -- --slicing
    ```  
1. UserからAdminに対して、Dockerコンテナの立ち上げを依頼する。今回はpingによる通信で、コンテナ立ち上げ依頼の処理を模倣した。
    ```
    ping 192.168.10.13
    ```  
    UserとAdminの間で通信が行えていることを確認する。
1. AdminがServerと通信し、Dockerコンテナを作成する。pingによる通信で、Dockerコンテナの作成処理を模倣する。
    ```
    ping 192.168.10.10
    ```  
    AdminとServer間で通信が行えていることを確認する。このとき、ServerではDockerコンテナをあらかじめ立ち上げておく(SSHを用いて、Admin側からコンテナを作成してもよい)。作成したコンテナは、仮想ブリッジを用いてServerの物理NICと接続しておく。コンテナのIPアドレスは、Userと同じネットワークに所属し、101よりも大きいもの(例：192.168.10.101/24)を指定する。  
1. Userとコンテナ間の通信を確立する。お互いにpingを送りあうことでパスが形成され、通信が確立される。
1. Network.htmlのファイルをブラウザで開くことで、可視化されたネットワークの状況を確認することができる。
1. Controllerによって作成された端末間のパスの途中にあるリンクを削除（ケーブルを抜く）と、パスの再構築が行われる。削除されたリンクを含むパスが削除され、新しい最短路のパスが形成される。ブラウザの可視化情報を確認することで、確かめることができる。
1. 削除されたリンクの復元を復元（抜いたケーブルを再度接続）すると、パスが再構築され、元のパスが再び張られる。これも、ブラウザの可視化情報から、確認することができる。  
1. UserからServerに対して、大量のパケットを送信する。例えば、以下のように短時間で複数のpingコマンドを打つ。  
    ```
    ping 192.168.10.101 -i 0.2
    ```  
    UserとServer間の通信量が増えると、既存のパスが張り替えられ、ボトルネックとなりうるスイッチを迂回するパスが生成される。ブラウザの可視化情報を確認すると、迂回すべきスイッチに印が付けられ、新しいパスが生成されていることがわかる。このとき、AdminとServerとの通信路は変化していないことも確認できる。

## サーバ用端末の設定内容
### 導入環境
- Ubuntu 16.04.1 LTS

### 導入が必要なもの
- Docker
 - 今回のデモではubuntuにApacheをインストールしたイメージを事前に準備
 - Docker version 1.12.5
- pipework
 - <https://github.com/jpetazzo/pipework>
 - Dockerコンテナに任意のIPアドレスを割り振るために導入
- bridge-utils
 - マシンのNICとDockerコンテナを接続する仮想ブリッジを作成するために導入

### サーバマシンの事前設定
1. マシンのNICに関する設定
  1. NICをdown
    ```
    sudo ifoconfig enp5s0 down
    ```
  1. マシンのNICからIPアドレスを削除
    ```
    sudo ifconfig enp5s0 0.0.0.0
    ```
  1. マシンのNICをup
    ```
    sudo ifoconfig enp5s0 up
    ```
1. マシンのNICとDockerコンテナを結ぶ仮想ブリッジの作成
  1. DockerコンテナとマシンのNICをつなぐ仮想ブリッジbr0を追加
    ```
    sudo brctl addbr br0
    ```
  1. 仮想ブリッジに静的なMACアドレスを指定
    ```
    sudo ifocnfig br0 hw ether 00:00:00:00:00:01
    ```
  1. 仮想ブリッジにIPアドレスを割り当て
    ```
    sudo ifconfig br0 192.168.10.10/24
    ```
  1. 仮想ブリッジとNICを接続
    ```
    sudo brctl addif enp5s0
    ```

### Dockerコンテナの起動手順(デモの再現方法 5.の詳細)
1. Dockerコンテナを起動
  ```
  docker start <コンテナ名>
  ```
1. コンテナと作成したブリッジをpipeworkで接続し，静的にIPアドレスを割り当て
  ```
  sudo pipework br0 <起動したコンテナのID> 192.168.10.101/24
  ```
